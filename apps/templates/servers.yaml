apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet

metadata:
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
  - git:
    repoURL: https://github.com/rlaisqls/xquare-gitops-repo-staging.git
    revision: HEAD
    files:
      - path: resource/{{ .Values.spec.environment }}/**/resource.json

template: 
  metadata:
    name: {{ .Values.Name }}

  spec:
    destination:
      server: {{ .Values.spec.destination.server }} 
      namespace: xquare

    project: {{ .Values.spec.project }}

    source:
      path: {{ .Values.spec.source.path }}
      repoURL: {{ .Values.spec.source.repoURL }}
      targetRevision: {{ .Values.spec.source.targetRevision }}

    syncPolicy:
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true

