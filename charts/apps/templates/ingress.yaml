apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: {{ .Values.spec.project }}-ingress
  labels:
    app.kubernetes.io/instance: xquare-ingresstest
  namespace: xquare
spec:
  ingressClassName: contour
  routes:
    {{- $environment := .Values.spec.environment }}
    {{- range $json := $.Files.Glob (printf "resource/%s/**" $environment) }}
    {{- $jsonData := $json | toString | fromJson }}
    {{- if ne $jsonData.Prefix "" }}
    - conditions:
      - prefix: {{ $jsonData.config.Prefix }}
      services:
        - name: {{ $jsonData.config.Name }}-{{ $jsonData.config.Type }}-{{ $jsonData.config.Environment }}
          port: 80
    {{- end }}
    {{- end }}