apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: {{ .Values.spec.project }}-ingress
  labels:
    app.kubernetes.io/instance: xquare-ingresstest
  namespace: xquare
spec:
  ingressClassName: contour
  routes:
    - conditions:
      {{- $environment := .Values.spec.environment }}
      {{- range $json := $.Files.Glob (printf "resource/%s/**" $environment) }}
      {{- $jsonData := $json | toString | fromJson }}
      {{- if ne $jsonData.Prefix "" }}
      - prefix: {{ $jsonData.Prefix }}
      services:
        - name: {{ $jsonData.Name }}-{{ $jsonData.Type }}-{{ $jsonData.Environment }}
          port: 80
      {{- end }}
      {{- end }}